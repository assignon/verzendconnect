{% extends 'base.html' %}
{% load static i18n seo_tags %}

{% block title %}{{ product.name }} - {{ product.category.name }}{% endblock %}
{% block meta_title %}{{ product.name }} - {{ product.category.name }} | VerzendConnect{% endblock %}
{% block meta_description %}{{ product.description|default:product.name|truncate_description }}{% endblock %}
{% block meta_keywords %}{{ product.name }}, {{ product.category.name }}, event rental, party supplies{% endblock %}
{% block og_type %}product{% endblock %}
{% block og_title %}{{ product.name }}{% endblock %}
{% block og_description %}{{ product.description|default:product.name|truncate_description }}{% endblock %}
{% block og_image %}{% if product.primary_image %}{% og_image product.primary_image.image.url %}{% else %}{% og_image %}{% endif %}{% endblock %}
{% block og_image_alt %}{{ product.name }}{% endblock %}
{% block twitter_title %}{{ product.name }}{% endblock %}
{% block twitter_description %}{{ product.description|default:product.name|truncate_description }}{% endblock %}
{% block twitter_image %}{% if product.primary_image %}{% og_image product.primary_image.image.url %}{% else %}{% og_image %}{% endif %}{% endblock %}
{% block canonical_url %}{% absolute_url product.get_absolute_url %}{% endblock %}

{% block extra_head %}
<!-- Product Structured Data -->
{% product_schema product %}

<!-- Breadcrumb Structured Data -->
{% breadcrumb_schema breadcrumb_items %}
{% endblock %}

{% block content %}
<div class="container-custom py-8 md:py-12">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
        <ol class="flex items-center gap-2 text-sm text-secondary-500">
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="{% url 'core:home' %}" class="hover:text-primary-600" itemprop="item">
                    <span itemprop="name">Home</span>
                </a>
                <meta itemprop="position" content="1">
            </li>
            <li><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg></li>
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="{{ product.category.get_absolute_url }}" class="hover:text-primary-600" itemprop="item">
                    <span itemprop="name">{{ product.category.name }}</span>
                </a>
                <meta itemprop="position" content="2">
            </li>
            <li><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg></li>
            <li class="text-secondary-800 font-medium truncate max-w-[200px]" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <span itemprop="name">{{ product.name }}</span>
                <meta itemprop="position" content="3">
            </li>
        </ol>
    </nav>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
        <!-- Image Gallery -->
        <div class="space-y-4">
            <!-- Main Image -->
            <div class="aspect-square rounded-2xl overflow-hidden bg-secondary-100">
                {% if product.primary_image %}
                <img id="main-product-image" src="{{ product.primary_image.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='{% static 'images/placeholder.svg' %}'; this.classList.add('p-8', 'object-contain')">
                {% else %}
                <img id="main-product-image" src="{% static 'images/placeholder.svg' %}" alt="{{ product.name }}" class="w-full h-full object-contain p-8">
                {% endif %}
            </div>
            
            <!-- Thumbnails -->
            {% if product.images.count > 1 %}
            <div class="flex gap-3 overflow-x-auto pb-2">
                {% for image in product.images.all %}
                <button 
                    data-thumbnail="{{ image.image.url }}"
                    class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 {% if image.is_primary %}ring-2 ring-primary-500 border-primary-500{% else %}border-transparent hover:border-primary-300{% endif %} transition-all bg-secondary-100"
                >
                    {% if image.image %}
                    <img src="{{ image.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='{% static 'images/placeholder.svg' %}'; this.classList.add('p-2', 'object-contain')">
                    {% else %}
                    <img src="{% static 'images/placeholder.svg' %}" alt="{{ product.name }}" class="w-full h-full object-contain p-2">
                    {% endif %}
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div class="space-y-6">
            <!-- Category & Title -->
            <div>
                <a href="{{ product.category.get_absolute_url }}" class="text-sm text-primary-600 font-medium hover:text-primary-700">
                    {{ product.category.name }}
                </a>
                <h1 class="font-display text-3xl md:text-4xl font-bold text-secondary-900 mt-2">
                    {{ product.name }}
                </h1>
            </div>
            
            <!-- Price -->
            <div class="flex items-baseline gap-3">
                {% if product.is_on_sale %}
                <span class="text-3xl font-bold text-primary-600">€{{ product.sale_price }}</span>
                <span class="text-xl text-secondary-400 line-through">€{{ product.price }}</span>
                <span class="badge bg-error-100 text-error-700">Save {{ product.discount_percentage }}%</span>
                {% else %}
                <span class="text-3xl font-bold text-secondary-900">€{{ product.price }}</span>
                {% endif %}
            </div>
            
            <!-- Stock Status -->
            <div class="flex items-center gap-2">
                {% if product.in_stock %}
                <span class="w-3 h-3 bg-success-500 rounded-full"></span>
                <span class="text-success-700 font-medium">In Stock</span>
                <span class="text-secondary-500">({{ product.stock }} available)</span>
                {% else %}
                <span class="w-3 h-3 bg-error-500 rounded-full"></span>
                <span class="text-error-700 font-medium">Out of Stock</span>
                {% endif %}
            </div>
            
            <!-- Short Description -->
            {% if product.short_description %}
            <p class="text-secondary-600 text-lg">{{ product.short_description }}</p>
            {% endif %}
            
            <!-- Event Types -->
            {% if product.event_types.exists %}
            <div class="flex flex-wrap gap-2">
                <span class="text-sm text-secondary-500">Perfect for:</span>
                {% for event in product.event_types.all %}
                <a href="{{ event.get_absolute_url }}" class="badge badge-primary hover:bg-primary-200 transition-colors">
                    {{ event.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if product.is_rental %}
            <!-- Rental Dates (Only for rental products) -->
            <div class="pt-4 border-t border-secondary-200 space-y-4">
                <h3 class="font-semibold text-lg text-secondary-800">{% trans "Rental Period" %}</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="rental-start-date" class="block text-sm font-medium text-secondary-700 mb-2">
                            {% trans "Start Date" %} *
                        </label>
                        <input 
                            type="date" 
                            id="rental-start-date" 
                            name="rental_start_date"
                            min="{{ min_rental_date|date:'Y-m-d' }}"
                            {% if product.rental_end_date %}max="{{ product.rental_end_date|date:'Y-m-d' }}"{% endif %}
                            class="w-full px-4 py-3 rounded-xl border-2 border-secondary-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20"
                            required
                        >
                        <p class="text-xs text-secondary-500 mt-1">
                            {% trans "Earliest available:" %} {{ min_rental_date|date:"d M Y" }}
                        </p>
                    </div>
                    <div>
                        <label for="rental-end-date" class="block text-sm font-medium text-secondary-700 mb-2">
                            {% trans "Return Date" %} *
                        </label>
                        <input 
                            type="date" 
                            id="rental-end-date" 
                            name="rental_end_date"
                            min="{{ min_rental_date|date:'Y-m-d' }}"
                            {% if product.rental_end_date %}max="{{ product.rental_end_date|date:'Y-m-d' }}"{% endif %}
                            class="w-full px-4 py-3 rounded-xl border-2 border-secondary-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20"
                            required
                        >
                        {% if product.rental_end_date %}
                        <p class="text-xs text-secondary-500 mt-1">
                            {% trans "Latest return:" %} {{ product.rental_end_date|date:"d M Y" }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                {% if product.rental_start_date or product.rental_end_date %}
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <p class="text-sm text-blue-800">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {% trans "This product is available for rental" %}
                        {% if product.rental_start_date %}{% trans "from" %} {{ product.rental_start_date|date:"d M Y" }}{% endif %}
                        {% if product.rental_end_date %}{% trans "until" %} {{ product.rental_end_date|date:"d M Y" }}{% endif %}
                    </p>
                </div>
                {% endif %}

                <!-- Stock availability message -->
                <div id="availability-message" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                    <p class="text-sm text-yellow-800" id="availability-text"></p>
                </div>
            </div>
            {% else %}
            <!-- Selling Product Notice -->
            <div class="pt-4 border-t border-secondary-200">
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <p class="text-sm text-green-800">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        {% trans "This product is available for purchase. No rental dates required." %}
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Quantity and Add to Cart -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <div class="flex items-center border-2 border-secondary-200 rounded-xl" data-quantity-wrapper>
                    <button data-quantity-btn="decrease" class="px-4 py-3 hover:bg-secondary-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                    </button>
                    <input type="number" value="1" min="1" max="{{ product.stock }}" id="quantity-input" class="w-16 text-center border-0 focus:ring-0">
                    <button data-quantity-btn="increase" class="px-4 py-3 hover:bg-secondary-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </button>
                </div>
                
                <button 
                    id="add-to-cart-btn"
                    onclick="addToCart()"
                    class="btn btn-primary flex-1 {% if not product.in_stock %}opacity-50 cursor-not-allowed{% endif %}"
                    {% if not product.in_stock %}disabled{% endif %}
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    {% if product.is_rental %}{% trans "Add to Cart" %}{% else %}{% trans "Buy Now" %}{% endif %}
                </button>
            </div>
            
            <!-- Full Description -->
            <div class="pt-6 border-t border-secondary-200">
                <h3 class="font-semibold text-lg text-secondary-800 mb-4">Description</h3>
                <div class="prose prose-secondary max-w-none">
                    {{ product.description|linebreaks }}
                </div>
            </div>
        </div>
    </div>
    
    {% if product.is_rental %}
    <!-- Products You Can Buy With This Rental -->
    {% with selling_products=product.get_related_selling_products %}
    {% if selling_products %}
    <section class="mt-16 pt-12 border-t border-secondary-200">
        <h2 class="section-title mb-4">{% trans "Products You Can Buy" %}</h2>
        <p class="text-secondary-600 mb-8">{% trans "Complete your rental with these products for purchase." %}</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            {% for selling_product in selling_products %}
            {% include 'core/partials/product_card.html' with product=selling_product %}
            {% endfor %}
        </div>
    </section>
    {% endif %}
    {% endwith %}
    {% endif %}

    <!-- Related Products -->
    {% if related_products %}
    <section class="mt-16 pt-12 border-t border-secondary-200">
        <h2 class="section-title mb-8">{% trans "Related Products" %}</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            {% for related in related_products %}
            {% include 'core/partials/product_card.html' with product=related %}
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Product type - determines if rental dates are needed
const isRentalProduct = {{ product.is_rental|yesno:"true,false" }};

// Set minimum date for rental start
document.addEventListener('DOMContentLoaded', function() {
    if (isRentalProduct) {
        const startDateInput = document.getElementById('rental-start-date');
        const endDateInput = document.getElementById('rental-end-date');
        
        if (startDateInput && endDateInput) {
            // When start date changes, update end date minimum
            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    // End date must be after start date
                    const startDate = new Date(this.value);
                    startDate.setDate(startDate.getDate() + 1);
                    const minEndDate = startDate.toISOString().split('T')[0];
                    endDateInput.min = minEndDate;
                    
                    // If current end date is before new minimum, reset it
                    if (endDateInput.value && endDateInput.value <= this.value) {
                        endDateInput.value = '';
                    }
                }
            });
        }
    }
});

// Add to cart - handles both rental and selling products
function addToCart() {
    const quantity = parseInt(document.getElementById('quantity-input').value) || 1;
    const productId = {{ product.id }};
    
    let payload = {
        product_id: productId,
        quantity: quantity
    };
    
    if (isRentalProduct) {
        // For rental products, validate and include dates
        const startDate = document.getElementById('rental-start-date').value;
        const endDate = document.getElementById('rental-end-date').value;
        
        // Validate dates
        if (!startDate) {
            showNotification('{% trans "Please select a rental start date" %}', 'error');
            document.getElementById('rental-start-date').focus();
            return;
        }
        
        if (!endDate) {
            showNotification('{% trans "Please select a return date" %}', 'error');
            document.getElementById('rental-end-date').focus();
            return;
        }
        
        if (new Date(endDate) <= new Date(startDate)) {
            showNotification('{% trans "Return date must be after start date" %}', 'error');
            document.getElementById('rental-end-date').focus();
            return;
        }
        
        payload.rental_start_date = startDate;
        payload.rental_end_date = endDate;
    }
    
    // Add to cart via AJAX
    fetch('{% url "orders:cart_add" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count in header
            const cartCountElements = document.querySelectorAll('[data-cart-count]');
            cartCountElements.forEach(el => {
                el.textContent = data.cart_count;
                el.classList.remove('hidden');
            });
            
            showNotification(data.message || '{% trans "Added to cart!" %}', 'success');
        } else {
            showNotification(data.error || '{% trans "Failed to add to cart" %}', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('{% trans "An error occurred. Please try again." %}', 'error');
    });
}

// Simple notification function
function showNotification(message, type) {
    // Remove existing notifications
    document.querySelectorAll('.notification-toast').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification-toast fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}

